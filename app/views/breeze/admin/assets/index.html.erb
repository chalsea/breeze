<% content_for :title, "Assets" %>

<% content_for :head do %>
  <%= stylesheet_link_tag "/breeze/javascripts/jcrop/css/jquery.Jcrop.css", "/breeze/javascripts/uploadify/uploadify.css" %>
  <%= javascript_include_tag "/breeze/javascripts/assets", "/breeze/javascripts/jcrop/js/jquery.Jcrop.min.js", "/breeze/javascripts/uploadify/swfobject.js", "/breeze/javascripts/uploadify/uploadify.js" %>
<% end %>

<%= pane_layout do |main| %>
  <% main.header do %>
  
  <% end %>
  <% main.inner do %>
    <%= scrollable_layout :id => :assets do %>
      <%= render :partial => "assets", :locals => { :assets => @assets, :folder => @folder } %>
    <% end %>
  <% end %>
<% end %>

<% content_for :left do %>
  <%= pane_layout do |left| %>
    <% left.header do %>
      <h2>Assets</h2>
    <% end %>
    <% left.inner do %>
      <%= content_tag :div, :id => :folders do %>
        <%= content_tag :ul, :class => "folders" do %>
          <%= render :partial => "folder", :object => "/" %>
        <% end %>
      <% end %>
    <% end %>
  <% end %>
<% end %>

<% content_for :right do %>
  <%= pane_layout do |right| %>
    <% right.inner do %>
      <%= render :partial => "upload" %>
    <% end %>
  <% end %>
<% end -%>

<script type="text/javascript" charset="utf-8">
  $(function() {
    $('#right #uploader').each(function() {
      script_data = {};
      script_data[$('meta[name=csrf-param]').attr('content')] = $('meta[name=csrf-token]').attr('content');
      script_data[$(this).attr('data-session-key')] = $(this).attr('data-session-id');
      $(this).uploadify({
        uploader:     '/breeze/javascripts/uploadify/uploadify.swf',
        script:       '/breeze/javascripts/uploadify/uploadify.php',
        folder:       '/breeze/javascripts/uploadify/uploads-folder',
        cancelImg:    '/breeze/images/icons/delete.png',
        buttonImg:    '/breeze/images/buttons/upload.png',
        width:        215,
        height:       40,
        multi:        true,
        auto:         true,
        script:       '/admin/assets',
        scriptData:   script_data,
        fileDataName: 'file',
        wmode:        'transparent',
        folder:       '<%= @folder || "/" %>',
        
        onComplete: function(event, queue_id, file_obj, response, data) {
          var id = /id="([^"]+)"/.exec(response);
          if (id && id[1]) {
            $('#' + id[1]).remove();
          }
          
          var match = /class="(\w+) asset/.exec(response);
          var group = match ? match[1] : 'asset';
          $('#assets .' + group + '-assets').prepend(response);
          show_or_hide_asset_section_headings();
          return true;
        }
      });
      
      $('#right .upload.button').click(function() {
        
        return false;
      });
    });
    
    show_or_hide_asset_section_headings();
    $('#left #folders').tree({
      ui: {
        theme_path: '/breeze/javascripts/jstree/themes/breeze/style.css',
        theme_name: 'breeze',
        dots: false,
        selected_delete: false
      },
      plugins: {
        contextmenu: {}
      },
      types: {
        'root': {
          valid_children: [ 'file', 'folder' ],
          creatable: true,
          deletable: false,
          renameable: false
        },
        'folder': {
          valid_children: [ 'file', 'folder' ],
          creatable: true,
          deletable: true,
          renameable: true
        }
      },
      rules: {
        multiple: false,
        drag_copy: false
      },
      callback: {
        onselect: function(node, tree) {
          folder = $(node).attr('data-folder');
          $('#right #uploader').uploadifySettings('folder', folder);
          $('#assets')
            .fadeTo('normal', 0.5)
            .load('/admin/assets/folders/' + folder.replace(/\//g, '%2f'), function() {
              show_or_hide_asset_section_headings();
              $(this).fadeTo('normal', 1.0);
            });
        },
        onmove: function(move_object) {
        }
      }
    });
  });
</script>